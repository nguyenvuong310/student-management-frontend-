pipeline {
  agent {
    kubernetes {
        cloud 'test-k8s-cloud'
      defaultContainer 'kaniko'
      yaml """
apiVersion: v1
kind: Pod
spec:
  containers:
    - name: kaniko
      image: gcr.io/kaniko-project/executor:debug
      imagePullPolicy: Always
      command: [sleep]
      args: ["999999"]
      volumeMounts:
        - name: workspace-volume
          mountPath: /home/jenkins/agent
        - name: docker-config
          mountPath: /kaniko/.docker/
  volumes:
    - name: workspace-volume
      emptyDir: {}
    - name: docker-config
      secret:
        secretName: dockerhub-credentials
        items:
          - key: .dockerconfigjson
            path: config.json
"""
    }
  }

  environment {
    DOCKER_IMAGE_NAME = 'vuong676/listvdt-frontend-web'
  }

  parameters {
    string(name: 'TAG_NAME', defaultValue: '', description: 'Tag name (e.g. v1.0.0)')
  }

  stages {
    stage('Checkout Source') {
      steps {
        container('kaniko') {
          checkout scm
        }
      }
    }

    stage('Build & Push with Kaniko') {
      when {
        expression { return params.TAG_NAME?.trim() }
      }
      steps {
        container('kaniko') {
          script {
            def fullTag = "${DOCKER_IMAGE_NAME}:${TAG_NAME}"
            echo "Building and pushing image: ${fullTag}"
            sh """
              /kaniko/executor \
                --context `pwd` \
                --dockerfile `pwd`/Dockerfile \
                --destination=${fullTag}
            """
          }
        }
      }
    }
  }

  post {
    always {
      echo 'Pipeline đã kết thúc.'
      cleanWs()
    }
  }
}