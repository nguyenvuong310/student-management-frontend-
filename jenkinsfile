pipeline {
  agent {
    kubernetes {
      cloud 'test-k8s-cloud'
      defaultContainer 'kaniko'
      yaml """
apiVersion: v1
kind: Pod
spec:
  containers:
    - name: kaniko
      image: gcr.io/kaniko-project/executor:debug
      imagePullPolicy: Always
      command: [sleep]
      args: ["999999"]
      volumeMounts:
        - name: workspace-volume
          mountPath: /home/jenkins/agent
        - name: docker-config
          mountPath: /kaniko/.docker/
  volumes:
    - name: workspace-volume
      emptyDir: {}
    - name: docker-config
      secret:
        secretName: dockerhub-credentials
        items:
          - key: .dockerconfigjson
            path: config.json
"""
    }
  }

  environment {
    DOCKER_IMAGE_NAME = 'vuong676/listvdt-frontend-web'
  }

  parameters {
    string(name: 'TAG_NAME', defaultValue: '', description: 'Tag name (e.g. v1.0.0)')
  }

  stages {
    stage('1. Checkout Code') {
      steps {
        container('kaniko') {
          git(
            url: 'https://github.com/nguyenvuong310/student-management-frontend-.git',
            branch: 'main',
            credentialsId: 'github-cred'
          )
          echo "âœ… Checkout thÃ nh cÃ´ng."
          sh "ls -la" // kiá»ƒm tra thÆ° má»¥c clone
        }
      }
    }

    stage('2. Build & Push with Kaniko') {
      when {
        expression { return params.TAG_NAME?.trim() }
      }
      steps {
        container('kaniko') {
          script {
            def fullTag = "${DOCKER_IMAGE_NAME}:${TAG_NAME}"
            echo "ðŸš€ Building and pushing image: ${fullTag}"
            sh """
              /kaniko/executor \
                --context `pwd` \
                --dockerfile `pwd`/student-management-frontend-/Dockerfile \
                --destination=${fullTag}
            """
          }
        }
      }
    }
  }

  post {
    always {
      echo 'ðŸ§¹ Pipeline Ä‘Ã£ káº¿t thÃºc.'
      cleanWs()
    }
  }
}